---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(Hmisc)
library(statmod)
```

```{r}
allLower <- function(x) {
  x = gsub("(^|[[:space:]])([[:alpha:]])",
           "\\1\\L\\2",
           x,
           perl = TRUE)
  return(x)
}
firstUp <- function(x) {
  str_sub(x, 1,1) <- tolower(str_sub(x, 1,1))
  return(x)
}

allLower('boork city')
```





```{r}
clean_date_str = function(date_str) {
  mdy = mdy(date_str)
  ymd = ymd(date_str)
  
  if(is.na(mdy)){
    if(is.na(ymd)){
      return(NA)
    }
    else {return(ymd)}
  }
  else {return(mdy)}
}

# fmt_df_dates = function(df) {
#   df = df %>% mutate('START.DATE' = clean_data_str(START.DATE), 'END.DATE' = clean_data_str(END.DATE))
#   return(df)

clean_text_col = function(txt) {
  # Remove all chars not letters or spaces
  txt = gsub("[^[:alnum:]#()-]", " ", txt)
  
  # Change all chars to lower
  txt = tolower(txt)
  
  # Remove other
  txt = gsub("other", "", txt)
  
  # Replace all multi space with single space
  # Remove all white space in begin and end
  txt = gsub("\\s+", " ", str_trim(txt))
  return(txt)
}
```

```{r}
spills$Locality = spills$Locality %>% tolower() %>% toTitleCase()

spills$`Program Facility Name`= spills$`Program Facility Name` %>% tolower() %>% toTitleCase()

spills$`Street 1` = spills$`Street 1` %>% tolower() %>% toTitleCase()
```



```{r}
spills_clean = read_csv("../data/spills_clean.csv")
spills_clean = spills_clean %>% select(-`Street 2`,-`ZIP Code`,-Waterbody)
```

```{r}
spills_clean %>% 
  filter(Units == 'Gallons') %>% 
  filter(`Material Family` == 'Petroleum') %>% 
  group_by(`Material Name`) %>% 
  summarise(sum(Quantity))
```

## Change lbs to gallons using approximate factor of 1/6
```{r}
spills_clean %>% 
  filter(Units == 'Pounds' )
```

```{r}

sum(is.na(spills_clean))
```

```{r}
spills_clean %>% 
  select_if(function(x) any(is.na(x))) %>% 
  summarise_each(funs(sum(is.na(.))))

spills_clean = spills_clean %>% drop_na()
```

```{r}
colnames(spills_clean)
```


```{r}
spills_clean = spills %>%
  mutate(Locality = gsub(".*New City.*", "Manhattan", Locality,perl=TRUE)) %>%
  mutate(Locality = gsub(".*Ny.*", "Manhattan", Locality,perl=TRUE)) %>%
  mutate(Locality = gsub(".*NA.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Newyork City.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Ny City.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*New York (Manhattan).*", "Manhattan", Locality,perl=TRUE)) %>%
  mutate(Locality = gsub(".*New.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Ny Ny.*", "Manhattan", Locality,perl=TRUE)) %>%  
  mutate(Locality = gsub(".*New York New York.*", "Manhattan", Locality,perl=TRUE)) %>%  
  mutate(Locality = gsub(".*Statton Island.*", "Staten Island", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Statenisland.*", "Staten Island", Locality,perl=TRUE)) %>%  
  mutate(Locality = gsub(".*Manhateen.*", "Manhattan", Locality,perl=TRUE)) %>%  
  mutate(Locality = gsub(".*Manhattam.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*West Broadway, Manhattan.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Jamaica Bay.*", "Queens", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Wards Island Complex.*", "Wards Island", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Manhatten.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Man.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*New York.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Ney York.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*New York Harbor.*", "Manhattan", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Bronxs.*", "Bronx", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*Brookln.*", "Brooklyn", Locality,perl=TRUE)) %>% 
  mutate(Locality = gsub(".*East Harlem.*", "Harlem", Locality,perl=TRUE))
  
  
```

```{r}
spills_clean %>% 
  filter(County == 'New York') %>% 
  select(Locality, County) %>% 
  arrange(Locality) %>% 
  unique()
```

```{r}
spills_clean$County %>% unique() %>% sort()
```


```{r}
spills %>%
  mutate(Locality = gsub(".*New City.*", "Manhattan", Locality,perl=TRUE)) 
```


```{r}

spills = spills %>% filter(Quantity > 0)

# spills = spills %>% 
#   filter(!(`Source` %in% c('Missing Code in Old Data - Must be fixed','Unknown')))
```


```{r}
write_csv(spills_clean, '../data/spills_clean.csv')
```



```{r}

storage %>% left_join(., spills_clean, by=c("Material.Name" = "Materialhttps://cran.r-project.org/package=sampling Name"))
```

```{r}
spills %>% 
  filter(`Material Family` == 'Petroleum') %>% 
  filter(Quantity > 10) %>% count()
```

```{r}
spills %>% 
  select(`Contributing Factor`) %>% unique()
```



### Great Summary Graph
```{r}
colours = c("Petroleum" = colors[1], 
            "Greenhouse Gas" = colors[2], 
            "Hazardous Material" = colors[3], 
            "Petrochemical" = colors[4], 
            "Commodity Chemical" = colors[5])

spills_cleaner = spills_clean %>% 
  semi_join(storage, by = c('Material Name' = 'Material.Name'))

spills_cleaner %>% 
  group_by(`Source`,`Material Family`) %>% 
  summarise(total = log(sum(Quantity))) %>% 
  ggplot(aes(x = reorder(Source,total), y = total)) +
  geom_col(aes(fill=`Material Family`)) +
  scale_fill_manual(values = colours) +
  coord_flip() +
  labs(y='Total Spilled (log-scale)',
       x='') +
  scale_fill_brewer(palette='Set1') +
  theme_bw() +
  theme(legend.key=element_blank())

```

```{r}
library(scales)
county_name = 'Albany'
county_spills = spills %>% 
  semi_join(storage, by = c('Material Name' = 'Material.Name')) %>% 
  filter(County == county_name) %>% 
  group_by(`Material Name`) %>% 
  summarise(total_spilled = sum(Quantity)) %>% 
  arrange(desc(total_spilled)) %>% 
  slice(1:10)

county_spills %>% 
  ggplot(aes(x = reorder(`Material Name`,total_spilled), y = `total_spilled`)) +
  geom_point()+
  scale_y_continuous(trans='log10',
                     breaks = trans_breaks("log10", function(x) 10^x),
                     labels = trans_format("log10", math_format(10^.x))) +
  coord_flip() +
  labs(y='Total Spilled (Gallons)',
       x='') +
  scale_fill_brewer(palette='Set1') +
  theme_bw() +
  theme(legend.key=element_blank())
```


```{r}
spills = spills %>% filter(Quantity > 0)
spills = spills %>% mutate(spill_Rank = percent_rank(Quantity))
```


```{r}
storage_t %>% 
  group_by(Material.Name) %>% 
  summarise(tot = sum(Capacity.in.Gallons)) %>% 
  filter(tot > 1e4) %>%  select(Material Na)
```
```{r}
storage_t %>% 
  filter(!(Material.Name == 'zinc') 
```



```{r}
storage_t = storage_t %>% filter(!(Material.Name %in% c('other','empty')))
storage_t %>% select(Material.Name, `Material Family`) %>% arrange(`Material Family`) %>% unique()
```


```{r}
petrols = spills_clean %>% filter(`Material Family` == 'Petroleum') %>% select(`Material Name`) %>% unique()
hazards = spills_clean %>% filter(`Material Family` == 'Hazardous Materials') %>% select(`Material Name`) %>% unique()
other = spills_clean %>% filter(`Material Family` == 'Other') %>% select(`Material Name`) %>% unique()
```

```{r}
petrols = storage_t %>% filter(`Material Family` == 'Petroleum') %>% select(`Material.Name`) %>% unique()

petchem = storage_t %>% filter(`Material Family` == 'Petrochemical') %>% select(`Material.Name`) %>% unique()

commodity = storage_t %>% filter(`Material Family` == 'Commodity Chemical') %>% select(`Material.Name`) %>% unique()

hazard = storage_t %>% filter(`Material Family` == 'Hazardous Material') %>% select(`Material.Name`) %>% unique()

green = storage_t %>% filter(`Material Family` == 'Greenhouse Gas') %>% select(`Material.Name`) %>% unique()


```


```{r}
spills_clean = spills_clean %>% mutate('Material Family' = case_when(
  `Material Name` %in% petrols[[1]] ~ "Petroleum",
  `Material Name` %in% hazard[[1]] ~ "Hazardous Material",
  `Material Name` %in% petchem[[1]] ~ "Petrochemical",
  `Material Name` %in% commodity[[1]] ~ "Commodity Chemical",
  `Material Name` %in% green[[1]] ~ "Greenhouse Gas",
))
```




```{r}
storage_t = storage %>% mutate('Material Family' = case_when(
  Material.Name %in% petrols[[1]] ~ "Petroleum",
  Material.Name %in% hazards[[1]] ~ "Hazardous Material",
  
  
  Material.Name == 'ethylene glycol' ~ "Commodity Chemical",
  Material.Name == 'methanol' ~ "Commodity Chemical",
  Material.Name == 'toluene' ~ "Commodity Chemical",
  Material.Name == 'p-nitrotoluene' ~ "Commodity Chemical",
  Material.Name == 'white caustic' ~ "Commodity Chemical",
  
  
  Material.Name == 'propylene glycol, allyl ether' ~ "Commodity Chemical",
  Material.Name == 'fluosilicic acid' ~ "Commodity Chemical",
  
  Material.Name == 'diethylene glycol' ~ "Commodity Chemical",
  Material.Name == 'ethanol' ~ "Commodity Chemical",
  
  Material.Name == '#1 fuel oil' ~ "Petroleum",
  Material.Name == '1,1,1-Trichloroethane(TCA)' ~ "Greenhouse Gas",
  Material.Name == '1,1,2-trichloro-1,2,2-triflouroethane' ~ "Greenhouse Gas",
  Material.Name == '1,2-dichloro-1,1,2,2-tetrafluoroethane' ~ "Greenhouse Gas",
  
  Material.Name == 'benzene' ~ "Petrochemical",
  Material.Name == 'benzene,1-methylethyl-' ~ "Petrochemical",
  Material.Name == 'benzo(b)fluoranthene' ~ "Petrochemical",
  Material.Name == 'benzotrichloride' ~ "Petrochemical",
  Material.Name == 'benzoyl chloride' ~ "Petrochemical",
  Material.Name == 'butadiene' ~ "Petrochemical",
  Material.Name == 'pseudocumene' ~ "Petrochemical",
  
  Material.Name == 'aluminum sulfate' ~ "Commodity Chemical",
  Material.Name == 'adipic acid' ~ "Commodity Chemical",
  Material.Name == 'acetone' ~ "Commodity Chemical",
  Material.Name == '2-propanone' ~ "Commodity Chemical",
  Material.Name == '2-propenoic acid, 2-methyl-, methyl ester' ~ "Commodity Chemical",
  Material.Name == 'acetic acid' ~ "Commodity Chemical",
  Material.Name == 'acetic anhydride' ~ "Commodity Chemical",
  Material.Name == 'ammonia' ~ "Commodity Chemical",
  Material.Name == 'ammonium acetate' ~ "Commodity Chemical",
  Material.Name == 'ammonium bicarbonate' ~ "Commodity Chemical",
  Material.Name == 'ammonium bisulfite' ~ "Commodity Chemical",
  Material.Name == 'ammonium chloride' ~ "Commodity Chemical",
  Material.Name == 'ammonium fluoborate' ~ "Commodity Chemical",
  Material.Name == 'ammonium hydroxide' ~ "Commodity Chemical",
  Material.Name == 'ammonium silicofluoride' ~ "Commodity Chemical",
  Material.Name == 'ammonium sulfamate' ~ "Commodity Chemical",
  Material.Name == 'ammonium thiocyanate' ~ "Commodity Chemical",
  Material.Name == 'ammonium thiosulfate' ~ "Commodity Chemical",
  Material.Name == 'aniline' ~ "Commodity Chemical",
  Material.Name == 'chlorine' ~ "Commodity Chemical",
  Material.Name == 'caustic soda' ~ "Commodity Chemical",
  Material.Name == 'butyl acetate' ~ "Commodity Chemical",
  Material.Name == 'caustic potash' ~ "Commodity Chemical",
  Material.Name == 'caustic soda' ~ "Commodity Chemical",
  
  
  Material.Name == 'chlorobenzene' ~ "Commodity Chemical",
  Material.Name == 'chlorodifluoromethane' ~ "Greenhouse Gas",
  Material.Name == 'chloroethane' ~ "Commodity Chemical",
  Material.Name == 'chromic acetate' ~ "Commodity Chemical",
  Material.Name == 'chromic sulfate' ~ "Commodity Chemical",
  Material.Name == 'chromium' ~ "Commodity Chemical",
  
  Material.Name == 'chromous chloride' ~ "Commodity Chemical",
  Material.Name == 'clarified oil (resale/redistribute)' ~ "Petroleum",
  Material.Name == 'coal tar pitch volatiles' ~ "Petrochemical",
  Material.Name == 'copper' ~ "Commodity Chemical",
  Material.Name == 'cumene' ~ "Petrochemical",
  
  
  Material.Name == 'cupric sulfate' ~ "Commodity Chemical",
  Material.Name == 'cyclohexane' ~ "Commodity Chemical",
  Material.Name == 'cyclohexanone' ~ "Commodity Chemical",
  Material.Name == 'cyclohexylamine' ~ "Commodity Chemical",
  Material.Name == 'DEG' ~ "Hazardous Material",
  Material.Name == 'dibenzofuran' ~ "Petrochemical",
  
  
  Material.Name == 'hydrogen peroxide' ~ "Commodity Chemical",
  Material.Name == 'hydrogen chloride' ~ "Commodity Chemical",
  Material.Name == 'hydrochloric acid' ~ "Commodity Chemical",
  Material.Name == 'muriatic acid' ~ "Commodity Chemical",
  Material.Name == 'lead' ~ "Commodity Chemical",
  Material.Name == 'hexane' ~ "Petrochemical",
  
  
  Material.Name == 'MEK' ~ "Commodity Chemical",
  Material.Name == 'MDI (methylene diphenyl diisocyanate)' ~ "Commodity Chemical",
  Material.Name == 'phosphoric acid' ~ "Commodity Chemical",
  Material.Name == 'sodium' ~ "Commodity Chemical",
  Material.Name == 'sulfuric acid' ~ "Commodity Chemical",
  Material.Name == 'used oil (heating)' ~ "Petroleum",
  Material.Name == 'waste oil' ~ "Petroleum",
  Material.Name == 'zinc' ~ "Commodity Chemical",
  
  Material.Name %in% other[[1]] ~ "Other",
  TRUE ~ "Hazardous Material"
))
```

```{r}
write_csv(storage_t, '../data/storage_clean.csv')
```

