---
title: "R Notebook"
output: html_notebook
---

\
```{r}
library(tidyverse)
storage <- data.frame(read_csv('./data/storage_clean.csv'))
storage = drop_na(storage)
```

```{r}
storage = storage %>% select(-X1,-X1_1)
```
```{r}
storage = storage %>% distinct()
```


```{r}
storage = storage %>% 
  mutate(Locality = tolower(Locality)) %>% 
  left_join(counties, 
            by = c('County.FIPS'="County FIPS")) %>% 
  select(-`City Name`,-`Town Name`,-`Village Name`,-`Municipality`)
```

```{r}
storage$Tank.Type %>% unique()
```
```{r}

```

```{r}
Caps = function(x) {
  s = strsplit(x, " ")[[1]]
  return(paste(toupper(substring(s,1,1)), substring(s,2), sep="", collapse=" "))
}
```

```{r}
vec = c("bronx","new york city")
caps = Vectorize(Caps)

v = vec %>% caps()
```

```{r}
storage$Locality %>% mutate(Locality = caps(Locality))
```

```{r}
storage = storage %>% 
  mutate(Tank.Status = gsub("Tank Converted to Non-Regulated use", "Converted to Non-Regulated Use", Tank.Status,ignore.case = F, fixed = T))
```

```{r}
storage = storage %>% 
  mutate(Tank.Type = gsub("Missing Code in Old Data - Must be fixed", "Missing Code", Tank.Type,ignore.case = F, fixed = T)) %>% 
  mutate(Tank.Type = gsub("Steel/Carbon Steel/Iron", "Steel", Tank.Type,ignore.case = F, fixed = T))

```



```{r}
storage = storage %>% 
  mutate(Material.Name = gsub("kerosene [#1 fuel oil] (on-site consumption)", "#1 fuel oil", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("kerosene [#1 fuel oil] (resale/redistribute)", "#1 fuel oil", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("#2 fuel oil (on-site consumption)", "#2 fuel oil", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("#2 fuel oil (resale/redistribute)", "#2 fuel oil", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("#4 fuel oil (on-site consumption)", "#4 fuel oil", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("#4 fuel oil (resale/redistribute)", "#4 fuel oil", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("#5 fuel oil (on-site consumption)", "#5 fuel oil", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("#5 fuel oil (resale/redistribute)", "#5 fuel oil", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("#6 fuel oil (on-site consumption)", "#6 fuel oil", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("#6 fuel oil (resale/redistribute)", "#6 fuel oil", Material.Name,ignore.case = F, fixed = T)) %>%
  mutate(Material.Name = gsub("gasoline/ethanol", "ethanol", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("Diesel (E-Gen)", "diesel", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("used oil (heating, on-site consumption)", "used oil (heating)", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("waste oil/used oil", "waste oil", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("Biodiesel (E-Gen)", "biodiesel", Material.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Material.Name = gsub("biodiesel (heating, on-site consumption)", "biodiesel", Material.Name,ignore.case = F, fixed = T)) %>% 
  
  mutate(Site.Type.Name = gsub("Municipality (Incl. Waste Water Treatment Plants, Utilities, Swimming Pools, etc.)", "Municipality", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Site.Type.Name = gsub("Religious Building (Church, Synagogue, Mosque, Temple, etc.)", "Relgious Building", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Site.Type.Name = gsub("Manufacturing (Other than Chemical)/Processing", "Non-Chemical Manufacturing/Processing", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Site.Type.Name = gsub("Unknown", "Other", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Site.Type.Name = gsub("Apartment Building/Office Building", "Apartment/Office Building", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Site.Type.Name = gsub("Other Wholesale/Retail Sales", "Retail Gasoline Sales", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Site.Type.Name = gsub("Auto Service/Repair (No Gasoline Sales)", "Auto Service", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Site.Type.Name = gsub("Storage Terminal/Petroleum Distributor", "Petroleum Storage/Distribution", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Site.Type.Name = gsub("Hospital/Nursing Home/Health Care", "Hospital/Health Care", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Site.Type.Name = gsub("Airport/Airline/Air Taxi", "Airport", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  mutate(Site.Type.Name = gsub("Trucking/Transportation/Fleet Operation", "Trucking/Transport", Site.Type.Name,ignore.case = F, fixed = T)) %>% 
  
  mutate(Tank.Location = gsub("Aboveground - in contact with impervious barrier", "Aboveground (impervious barrier)", Tank.Location,ignore.case = F, fixed = T)) %>% 
  mutate(Tank.Location = gsub("Underground including vaulted with no access for inspection", "Underground (no access)", Tank.Location,ignore.case = F, fixed = T)) %>% 
  mutate(Tank.Location = gsub("Aboveground - in contact with soil", "Aboveground (soil contact)", Tank.Location,ignore.case = F, fixed = T)) %>% 
  mutate(Tank.Location = gsub("Aboveground on saddles, legs, stilts, rack or cradle"  ,"Aboveground (no ground contact)", Tank.Location,ignore.case = F, fixed = T)) %>%
  mutate(Tank.Location = gsub("Aboveground in Subterranean vault with access for inspections", "Aboveground (subterranean, with access)", Tank.Location,ignore.case = F, fixed = T)) %>% 
  mutate(Tank.Location = gsub("Tank with 10% or more below ground", "Tank (>10% below ground)", Tank.Location,ignore.case = F, fixed = T)) %>% 
  mutate(Locality = gsub("new york city", "new york", Locality,ignore.case = F, fixed = T)) %>% 
  mutate(County.Name = gsub("New York City", "New York", County.Name ,ignore.case = F, fixed = T))

```

```{r}
storage = storage %>% mutate(Rank = percent_rank(Capacity.in.Gallons))
```



```{r}
write_csv(storage,'./data/storage_clean.csv')
```

```{r}
top5Chems = storage %>% 
  group_by(Material.Name) %>% 
  summarize(total = sum(Capacity.in.Gallons)) %>% 
  top_n(5,total)

storageFiltered = semi_join(storage, top5Chems, by = 'Material.Name')

storageFiltered %>% 
  ggplot(aes(x=reorder(Site.Type.Name,Capacity.in.Gallons, function(x) sum(x)), y=Capacity.in.Gallons)) + 
  geom_col(aes(fill=Material.Name)) +
  labs(title='Total Capacity by Site',
       x='Sites',
       y='Capacity in Gallons') +
  scale_fill_brewer(palette='Set1') +
  coord_flip() + 
  theme_bw() +
  theme(legend.key=element_blank())

```

```{r}
storageFiltered %>% 
  ggplot(aes(x=reorder(Tank.Location,Capacity.in.Gallons, function(x) sum(x)), y=Capacity.in.Gallons)) + 
  geom_col(aes(fill=Material.Name)) +
  labs(title='Total Capacity by Tank Location',
       x='Sites',
       y='Capacity in Gallons') +
  scale_fill_brewer(palette='Set1') +
  coord_flip() + 
  theme_bw() +
  theme(legend.key=element_blank())
```

```{r}
```


```{r}

storageFiltered %>% 
  ggplot(aes(x=reorder(Material.Name,Capacity.in.Gallons, function(x) sum(x)), y=Capacity.in.Gallons)) + 
  geom_col() +
  labs(title='Total Capacity by Material',
       x='Sites',
       y='Capacity in Gallons') +
  scale_fill_brewer(palette='Set1') +
  coord_flip() + 
  theme_bw() +
  theme(legend.key=element_blank())
```


```{r}
topChems = storage %>% 
  group_by(Material.Name) %>% 
  summarize(total = sum(Capacity.in.Gallons)) %>% 
  slice(20,total)

storageFiltered = semi_join(storage, topChems, by = 'Material.Name')
```

```{r}


```



```{r}
storage %>% 
  filter(Material.Name=="chlorine") %>% 
  group_by(Install.Date) %>% 
  summarize(sum_ = sum(Capacity.in.Gallons)) %>% 
  mutate(n = cumsum(sum_)) %>% 
  ggplot(aes(x = Install.Date, y = n)) +
  geom_area() +
  labs(title='Facility Install Date and Capacity',
       x='Install Date',
       y='Capacity') +
  scale_fill_brewer(palette='Set1') +
  theme_bw() +
  theme(legend.key=element_blank())
```
```{r}
storageFiltered %>% 
  group_by(Material.Name) %>% 
  ggplot(aes(x = Material.Name, y = Capacity.in.Gallons)) +
  geom_col() +
  labs(title='Total Capacity by Material',
       x='Sites',
       y='Capacity in Gallons') +
  scale_fill_brewer(palette='Set1') +
  theme_bw() +
  theme(legend.key=element_blank())
```
```{r}
storageFiltered %>% 
  ggplot(aes(x = reorder(Tank.Status,Capacity.in.Gallons, function(x) sum(x)), y = sum(Capacity.in.Gallons))) +
  geom_col(aes(fill=Material.Name)) +
  labs(title='Total Capacity by Material',
       x='Sites',
       y='Capacity in Gallons') +
  scale_fill_brewer(palette='Set1') +
  theme_bw() +
  coord_flip() + 
  theme(legend.key=element_blank())
```

```{r}
storage %>% 
  filter(Rank < 1e-2) 
```

